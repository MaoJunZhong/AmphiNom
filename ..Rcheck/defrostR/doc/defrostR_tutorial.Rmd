---
title: "Set to 'defrost': How to use defrostR for updating amphibian taxonomy"
author: "Christoph Liedtke"
date: "March, 2017"
output: 
  html_document:
    self_contained: true
    toc: True # table of content true
    toc_float:
      collapsed: false
      smooth_scroll: false
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
vignette: >
  %\VignetteIndexEntry{Set to 'defrost': How to use defrostR for updating amphibian taxonomy}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}    
---
<style type="text/css">
.text {
  text-align: justify;

}
</style>




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,  warning = FALSE, message = FALSE, echo = TRUE, tidy = FALSE, size="small")
options(width=100)
```
  
## Introduction
  
This package is aimed at trying to simplify the workflow of combining data sets from different sources that use different taxonomic nomenclature (specifically for amphibians). For example, two sources of important information for amphibian systematic are: Amphibian Species of the World (http://research.amnh.org/vz/herpetology/amphibia/) and Amphibia Web (http://amphibiaweb.org/). These use slightly different nomenclature. Moreover, in comparative studies, one often works with data from a range of sources such as spatial or conservation data from the IUCN red list (http://www.iucnredlist.org/) or phylogenetic information from published amphibian phylogenies such as those of Pyron and Wiens 2011 (MPE) and Pyron 2014 (Syst Biol). These sources have either made the decision to follow a specific taxonomic system or, more often, are no longer up to date. It can therefore be complicated to establish a universal or current nomenclature to be able to effectively combine data sets. As such, the main objective of this package is to harvest taxonomic classifications of all amphibian species listed on the ASW website, harvest all listed synonyms per species and then using this information, suggest "Frost" (ASW) names for any given list of taxa.

This package could also be useful for easily updating museum catalogs etc, or for producing summary statistics on species numbers for various taxonomic groupings, or to update species names in manuscripts etc. after a taxonomic group has received nomenclature revisions

Below are some examples of how to use the package.
  
### Load package
  
defrostR only depends on the "XML" package. Until defrostR is up on CRAN, this package needs to be installed manually first using install.packages("XML"). Then install defrostR from the source package provided (.tar.gz).

```{r message=FALSE, warning=FALSE}
library(XML)
library(defrostR)
```

```{r echo=F, message=FALSE, warning=FALSE}
library(knitr)
```
  
## Compile ASW taxonomy
  
a version of the current species list is stored in the defrostR package internally. This may of course be outdated and so to generate your own, up-to-date version run the getTaxonomy() function, but this may take 10 to 15 minutes...
##### build taxonomy:
```{r message=FALSE, warning=FALSE, results='hide'}
#asw_taxonomy<-getTaxonomy()
head(asw_taxonomy)
```

```{r echo=F, message=FALSE, warning=FALSE}
kable(head(asw_taxonomy), padding=2)
```

The function takes no arguments and essentially iterates through the ASW website, building the URL for each species via a bottom up approach (i.e. first looking for all orders, then superfamilies, then families, subfamilies, genera and finally species). The resulting table contains 6 columns, one for each taxonomic level (Order through to Species) and a 7th column with the URL for the ASW website for each species.  
    
#### Get some species stats  
  
##### the basics:
```{r message=FALSE, warning=FALSE, results='hide'}
aswStats(asw_taxonomy)
```

```{r echo=F, message=FALSE, warning=FALSE}
kable(aswStats(asw_taxonomy))
```

the summary function tabulates the number of units per each taxonomic level, based on the getTaxonomy() output. If no additional arguments are given, it will spit out stats for everything in your table.  
  
##### information on a specific group of interest:
```{r message=FALSE, warning=FALSE, results='hide'}
aswStats(asw_taxonomy, Family="Plethodontidae")
```

```{r echo=F, message=FALSE, warning=FALSE}
kable(aswStats(asw_taxonomy, Family="Plethodontidae"))
```

Stats can also be given for a specific subset based on a name of any taxonomic level. To make sure everything is working properly, you could double check if this matches the information on the website: http://research.amnh.org/vz/herpetology/amphibia/index.php/  
  
##### taking a closer look:
```{r message=FALSE, warning=FALSE}
aswStats(asw_taxonomy, Family = "Plethodontidae",verbose = T)
```

turning on "verbose" returns a list instead of a table, listing the unit names per level. This is useful in its own right when wanting to get an overview or making graphical representations:  
  
##### Plot the results:
```{r message=FALSE, warning=FALSE, dev="png"}
plethodontid.stats<-aswStats(asw_taxonomy, Family = "Plethodontidae",verbose = T)
par(mar=c(1,1,1,1))
pie(plethodontid.stats$Genera[order(plethodontid.stats$Genera, decreasing = T)], cex=0.5, main = "No. of Species per Genus", col = rainbow(length(plethodontid.stats$Genera),s = 0.5), clockwise = T, border = NA)
```

  
## Compile Synonym list
  
The core of this package is to generate an up-to-date list of all possible synonyms per species, to facilitate matching data sets that might be using different names for the same species. Again, version of the current synonym list is stored in the defrostR package internally. This may of course be outdated and so to generate your own, up-to-date version run the getSynonym() function! The function takes the getTaxonomy() output as a reference and then looks through every species webpage, tabulating all listed synonyms. Generating a full list for all amphibian species can take a long long time (up to an hour). More realistically, you may only be interested in a specific taxonomic group and so you can narrow down your search.
  
##### list synonyms:
```{r message=FALSE, warning=FALSE, results='hide'}
plethodon_synonyms<-getSynonyms(asw_taxonomy, Genus="Plethodon")
head(plethodon_synonyms,n = 15)
```

```{r echo=F, message=FALSE, warning=FALSE}
kable(head(plethodon_synonyms,n = 15))
```

the output is a table with two columns, listing species names and the synonyms.
  
## Defrost something!!!
  
the main aim of this package is to facilitate unifying naming systems. As an example, lets look at how the names on Amphibia Web differ to those on ASW. Their most current taxonomy can be downloaded here: http://amphibiaweb.org/taxonomy/index.html#aweb, and a version is also stored internally in defrostR.
  
##### load the amphibia web taxonomy:
```{r message=FALSE, warning=FALSE}
amphweb<-amphweb
head(amphweb$species)
```

lets look at only Bufonidae:
```{r message=FALSE, warning=FALSE}
amphweb.bufonidae<-amphweb[amphweb$family=="Bufonidae",]
```

and lets "defrost" that list, using the synonym list created with getSynonyms(), here, using the version stored internally: 
```{r message=FALSE, warning=FALSE, results='hide'}
bufonidae.defrosted<-defrost(query=amphweb.bufonidae$species,asw = asw_synonyms)
head(bufonidae.defrosted)
```

```{r echo=F, message=FALSE, warning=FALSE}
kable(head(bufonidae.defrosted))
```

the output here is a table listing: the original query, a 'stripped' version, to make sure underscores etc. are no issue, a status column listing whether any names match and if not, whether they could be "defrosted" with no problem, or whether names were not found as listed synonyms or whether names are ambiguous and could refer to more than one species. A specific warning column is also included that, for now, only warns you if the resulting name changes contain duplicates. The final column lists the suggested Frost/ASW names.

various additional arguments can be invoked, whether for example ambiguities should be sorted out on the fly with the user deciding on the go and whether to pass forward the original query names if no match is found in the synonym list.
  
#### Print out a report
  
instead of looking through the output table of defrost(), we can also print out a report using the following function 
  
##### the basics:
```{r message=FALSE, warning=FALSE, results='hide'}
synonymReport(bufonidae.defrosted)
```

```{r echo=F, message=FALSE, warning=FALSE}
kable(synonymReport(bufonidae.defrosted))
```

this tells us that most of the names are up to date already, and defrostR could update 8 few more without any complications. however, there are 5 queries that could not be found (not listed in ASW), 5 queries which mach synonyms belonging to more than one species and most critically, the automatic defrosting has resulted in 10 cases which are not unique names (i.e. are synonyms)!
  
##### all the details:
```{r message=FALSE, warning=FALSE}
synonymReport(bufonidae.defrosted, verbose=T)
```

turning on verbose, lists all the species names that could not be "defrosted" and need to be looked at more closely. 

of course all of this can also be done manually from the defrost() output:

##### check which names are ambiguous:
```{r message=FALSE, warning=FALSE, results='hide'}
bufonidae.defrosted[bufonidae.defrosted$status=="ambiguous",]
```

```{r echo=F, message=FALSE, warning=FALSE}
kable(bufonidae.defrosted[bufonidae.defrosted$status=="ambiguous",])
```

##### check which names are now duplicated:
```{r message=FALSE, warning=FALSE, results='hide'}
bufonidae.defrosted[bufonidae.defrosted$warnings %in% "duplicated",]
```

```{r echo=F, message=FALSE, warning=FALSE}
kable(bufonidae.defrosted[bufonidae.defrosted$warnings %in% "duplicated",])
```
